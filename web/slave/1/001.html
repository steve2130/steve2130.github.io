<!DOCTYPE html>
<html>

  <head>
      <meta charset="utf-8">
      <link href="../../style-pages.css" rel="stylesheet" type="text/css"/>
      <meta name="viewport" content="width = device-width, initial-scale = 1"/>
      <title>1</title>
  </head>

  <body>
     <div class="image-box">

        <label for="button">
            <button id="next_page_button" type="button" class="PageTurningButton split right"></button>
        </label>

        <label for="button">
            <button id="previous_page_button" type="button" class="PageTurningButton split left "></button>
        </label>

        <img id="image" alt="image" src="images/001.jpg"/>

    </div>








    <script>
      const next_page_button = document.getElementById("next_page_button");
      const previous_page_button = document.getElementById("previous_page_button");
      const image = document.getElementById("image");



      next_page_button.addEventListener("click", fun => ToNextImage(), false);
      previous_page_button.addEventListener("click", fun => ToPreviousPage(), false);

      
      async function ToNextImage() {
          let returnValues = GetCurrentPageNumber();
          let leadingSourcePath = returnValues[0];
          let currentPage = parseInt(returnValues[1]);

          let imagePreload = preloadImage(leadingSourcePath, currentPage);

              imagePreload
                  .then(res => {
                      console.log(":)");
                  })
                  .catch(res => {
                      console.log(res);
                  });



          let nextPage = currentPage + 1;
          nextPage = AddLeadingZeros(nextPage);


          let fileExistance = CheckImageExistance(`${leadingSourcePath}/${nextPage}.jpg`);
          
              fileExistance
                  .then(res => {
                      image.src = `${leadingSourcePath}/${nextPage}.jpg`;
                  })  

                  .catch(res => {
                      window.location.href = "../../menu.html";
              });
      }

    async function ToPreviousPage() {
        let returnValues = GetCurrentPageNumber();
        let leadingSourcePath = returnValues[0];
        let currentPage = parseInt(returnValues[1]);


        let previousPage = currentPage - 1;
        previousPage = AddLeadingZeros(previousPage);


        let fileExistance = CheckImageExistance(`${leadingSourcePath}/${previousPage}.jpg`);

            fileExistance
                .then(res => {
                    image.src = `${leadingSourcePath}/${previousPage}.jpg`;
            })  

                .catch(res => {
                    window.location.href = "../../menu.html";
            });
    }







      function AddLeadingZeros(PageNumber) {
          PageNumber = PageNumber.toString();
          PageNumber = PageNumber.padStart(3, '0');
          return PageNumber;
      }


      function GetCurrentPageNumber() {
          let currentSourcePath = image.getAttribute("src");
          let currentSourcePathSplited = currentSourcePath.split("/");

          return [currentSourcePathSplited[0], currentSourcePathSplited[1]];
      }


      async function CheckImageExistance(SourcePath) {

          return new Promise((resolve, reject) => {
              let img = new Image();
              img.src = SourcePath;

              img.onload = () => resolve(img);

              img.onerror = () => reject('failed');
          })
      }

      async function preloadImage(sourcePath, currentPage) {
            return new Promise ((resolve, reject) => {
                /*Preload 1 image for now, change it if you want*/

                let image = new Array;
                image[0] = new Image();
                image[1] = new Image();
                image[2] = new Image();

                let nextPage = currentPage;

                for (i = 0; i < image.length; i++) {
                  nextPage = AddLeadingZeros(currentPage + 1);
                    
                    image[i].src = `${sourcePath}/${nextPage}.jpg`;

                    currentPage = currentPage + 1;
                }


                image.onload = () => resolve();
                image.onerror = () => reject();
            }) 
      }


      </script>



  </body>
</html>
